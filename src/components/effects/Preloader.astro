---
import { siteConfig } from "@/config";
import { url } from "@/utils/url-utils";
---

<div id="preloader" class="preloader">
  <div class="preloader-content">
    <div class="preloader-logo">
      {siteConfig.navbarLogo.type === 'image' ? (
        <img src={url(siteConfig.navbarLogo.value)} alt="Logo" class="logo-img" />
      ) : (
        <div class="logo-placeholder">
           <div class="i-material-symbols-home-pin-outline text-5xl text-[var(--primary)]"></div>
        </div>
      )}
    </div>
    <div class="preloader-spinner-container">
      <div class="preloader-spinner"></div>
    </div>
  </div>
</div>

<style is:global>
  :root {
    --preloader-bg: #ffffff;
  }
  
  html.dark :root {
    --preloader-bg: #1a1a1a;
  }

  .preloader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: var(--preloader-bg);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000000;
    transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.6s;
    pointer-events: all;
  }

  .preloader.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }

  .preloader-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
  }

  .preloader-logo {
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: preloader-pulse 2s infinite ease-in-out;
  }

  .logo-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    filter: drop-shadow(0 0 8px oklch(0.70 0.14 var(--hue) / 0.3));
  }

  .logo-placeholder {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .preloader-spinner-container {
    width: 48px;
    height: 48px;
    position: relative;
  }

  .preloader-spinner {
    width: 100%;
    height: 100%;
    border: 3px solid var(--btn-regular-bg);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: preloader-spin 1s cubic-bezier(0.5, 0.1, 0.4, 0.9) infinite;
  }

  @keyframes preloader-pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }

  @keyframes preloader-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* 防止加载过程中出现滚动条 */
  body:not(.loaded) {
    overflow: hidden;
  }
</style>

<script is:inline>
  (function() {
    const preloader = document.getElementById('preloader');
    let isHidden = false;
    
    function hidePreloader() {
      if (isHidden) return;
      if (preloader) {
        isHidden = true;
        preloader.classList.add('hidden');
        document.body.classList.add('loaded');
        setTimeout(() => {
          preloader.style.display = 'none';
        }, 600);
      }
    }

    // 监听资源加载完成
    if (document.readyState === 'complete') {
      hidePreloader();
    } else {
      window.addEventListener('load', hidePreloader);
    }

    // 兜底方案：5秒后强制隐藏
    setTimeout(hidePreloader, 5000);
  })();
</script>
